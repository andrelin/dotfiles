name: WSL
on: [push]

jobs:
  build:
    name: Test on WSL (Ubuntu 24.04)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          set-safe-directory: true

      - uses: Vampire/setup-wsl@v5
        with:
          distribution: Ubuntu-24.04
          additional-packages: curl git sudo
          wsl-conf: |
            [automount]
            options = "metadata"

      - name: Fix line endings
        shell: wsl-bash {0}
        run: find . -type f \( -name '*.sh' -o -name '*.zsh' -o -path '*/bin/*' \) -exec sed -i 's/\r$//' {} +

      - name: Configure
        shell: wsl-bash {0}
        run: bash -c "./bin/dotfiles -p"

      - name: Run tests
        shell: wsl-bash {0}
        run: |
          export DOTFILES=$PWD
          for t in test/test_*.sh; do bash "$t"; done
